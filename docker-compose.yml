version: "3.9"

services:
  orchestrator:
    build: ./orchestrator
    container_name: osint-orchestrator
    working_dir: /app
    ports:
      - "8000:8000"
    environment:
      # --- External APIs / optional ---
      - GOOGLE_CSE_API_KEY=${GOOGLE_CSE_API_KEY}
      - GOOGLE_CSE_CX=${GOOGLE_CSE_CX}
      - REACHER_BASE_URL=${REACHER_BASE_URL}
      # --- Internal service URLs (containers ŒºŒπŒªŒ¨ŒΩŒµ ŒºŒµœÑŒ±Œæœç œÑŒøœÖœÇ ŒºŒµ DNS service name + internal port) ---
      - SEARXNG_BASE_URL=http://searxng:8080
      - SEARXNG_URL=http://searxng:8080
      - OPENSEARCH_URL=http://opensearch:9200
      - REDIS_URL=redis://redis:6379/0
      # --- OpenSearch config ---
      - OPENSEARCH_HOST=opensearch
      - OPENSEARCH_PORT=9200
      - OPENSEARCH_USER=admin
      - OPENSEARCH_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-admin}
      - OSINT_INDEX=${OSINT_INDEX:-osint_docs}
      - EMBED_DIM=${EMBED_DIM:-384}
      # --- Python path ---
      - PYTHONPATH=/app
    volumes:
      - ./exports:/app/exports
      - ./:/app
    healthcheck:
      # Œ±œÄŒªœå check œåœÑŒπ œÑŒø FastAPI ŒµŒØŒΩŒ±Œπ ŒµœÄŒ¨ŒΩœâ
      test:
        [
          "CMD-SHELL",
          "python - <<'PY'\nimport urllib.request,sys; \ntry:\n  r=urllib.request.urlopen('http://127.0.0.1:8000/docs', timeout=5)\n  sys.exit(0 if r.status<400 else 1)\nexcept Exception:\n  sys.exit(1)\nPY"
        ]
      interval: 10s
      retries: 15
      timeout: 5s
      start_period: 20s
    depends_on:
      opensearch:
        condition: service_healthy
      searxng:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - osint

  searxng:
    image: searxng/searxng:latest
    container_name: osint-searxng
    ports:
      - "8081:8080"  # host:container
    restart: unless-stopped
    environment:
      # ŒîŒ≠œÉŒºŒµœÖœÉŒ∑ œÑŒ∑œÇ ŒµœÉœâœÑŒµœÅŒπŒ∫ŒÆœÇ 8080
      - BIND_ADDRESS=0.0.0.0:8080
      # ‚úÖ Œ£Œ©Œ£Œ§Œü secret env Œ≥ŒπŒ± œÑŒø official image (Œ≤Œ¨ŒªŒµ Œ¥œÖŒΩŒ±œÑœå string œÉœÑŒø .env)
      - SEARXNG_SECRET=${SEARXNG_SECRET:-change_me_please}
      # Optional ‚Äì Œ≥ŒπŒ± links/redirects Œ±œÄœå browser (host)
      - SEARXNG_BASE_URL=http://localhost:8081/
    healthcheck:
      # ŒßœÑœÖœÄŒ¨ œÑŒø œÄœÅŒ±Œ≥ŒºŒ±œÑŒπŒ∫œå search endpoint œéœÉœÑŒµ ŒΩŒ± œÄŒ¨œÅŒøœÖŒºŒµ 200 deterministically
      test: ["CMD-SHELL", "curl -sf 'http://127.0.0.1:8080/search?q=ping&format=json' >/dev/null || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 15
      start_period: 90s
    networks:
      - osint

  opensearch:
    image: opensearchproject/opensearch:2
    container_name: osint-opensearch-1
    environment:
      - discovery.type=single-node
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - bootstrap.memory_lock=true
      # üî¥ ŒëœÄŒµŒΩŒµœÅŒ≥ŒøœÄŒøŒØŒ∑œÉŒ∑ security Œ≥ŒπŒ± Œ±œÄŒªœåœÑŒ∑œÑŒ± œÑŒøœÄŒπŒ∫Œ¨
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - DISABLE_SECURITY_PLUGIN=true
      # ŒïŒΩŒ±ŒªŒªŒ±Œ∫œÑŒπŒ∫Œ¨, Œ≥ŒπŒ± enabled security:
      # - OPENSEARCH_INITIAL_ADMIN_PASSWORD=MyStrongPassw0rd!
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9200 >/dev/null || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 15s
    ports:
      - "9200:9200"
    networks:
      - osint

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2
    container_name: osint-opensearch-dashboards
    environment:
      - OPENSEARCH_HOSTS=["http://opensearch:9200"]
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    depends_on:
      opensearch:
        condition: service_healthy
    ports:
      - "5601:5601"
    networks:
      - osint

  redis:
    image: redis:7
    container_name: osint-redis-1
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - osint

  # ------------------------
  # Œ†œÅŒøŒ±ŒπœÅŒµœÑŒπŒ∫Œ¨ / Œ≤Œ±œÅŒπŒ¨ services (enable ŒºŒµ: `--profile extras`)
  # ------------------------
  social-analyzer:
    image: bukshee/social-analyzer:latest
    container_name: osint-social-analyzer-1
    environment:
      - PORT=9005
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    ports:
      - "9005:9005"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9005 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
    profiles: ["extras"]
    networks:
      - osint

  reacher:
    image: reacherhq/backend:latest
    container_name: osint-reacher-1
    environment:
      - LOG_LEVEL=info
    ports:
      - "8082:8080"
    deploy:
      resources:
        limits:
          memory: 512M
    profiles: ["extras"]
    networks:
      - osint

  theharvester:
    image: ghcr.io/laramies/theharvester:latest
    container_name: osint-theharvester-1
    entrypoint: ["/bin/sh", "-c", "tail -f /dev/null"]
    tty: true
    stdin_open: true
    volumes:
      - ./data/harvester_results:/results
    deploy:
      resources:
        limits:
          memory: 256M
    profiles: ["extras"]
    networks:
      - osint

  phoneinfoga:
    image: sundowndev/phoneinfoga:latest
    container_name: osint-phoneinfoga-1
    command: "serve -p 8080"
    ports:
      - "8083:8080"
    networks:
      - osint

  # ------------------------
  # üß™ Test runner (enable ŒºŒµ: `--profile tests`)
  # ------------------------
  orchestrator-tests:
    build: ./orchestrator
    container_name: osint-orchestrator-tests
    working_dir: /app
    command: >
      bash -c "
        pip install -U pytest pytest-asyncio respx &&
        pytest -q -vv"
    environment:
      - PYTHONPATH=/app
      - SEARXNG_BASE_URL=http://searxng:8080
      - SEARXNG_URL=http://searxng:8080
      - OPENSEARCH_URL=http://opensearch:9200
      - REDIS_URL=redis://redis:6379/0
      - OSINT_INDEX=${OSINT_INDEX:-osint_docs}
      - EMBED_DIM=${EMBED_DIM:-384}
      # optional externals (Œ±ŒΩ œÑŒ± œáœÅŒ∑œÉŒπŒºŒøœÄŒøŒπŒµŒØœÇ œÉœÑŒ± tests)
      - GOOGLE_CSE_API_KEY=${GOOGLE_CSE_API_KEY}
      - GOOGLE_CSE_CX=${GOOGLE_CSE_CX}
      - REACHER_BASE_URL=${REACHER_BASE_URL}
    volumes:
      - ./exports:/app/exports
      - ./tests:/app/tests
      - ./orchestrator:/app/orchestrator
    depends_on:
      opensearch:
        condition: service_healthy
      searxng:
        condition: service_healthy
      redis:
        condition: service_started
    profiles:
      - tests
    networks:
      - osint

networks:
  osint:
    driver: bridge
