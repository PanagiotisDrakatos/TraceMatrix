services:
  orchestrator:
    build: ./orchestrator
    working_dir: /app
    ports:
      - "8000:8000"
    environment:
      - GOOGLE_CSE_API_KEY=${GOOGLE_CSE_API_KEY}
      - GOOGLE_CSE_CX=${GOOGLE_CSE_CX}
      - REACHER_BASE_URL=${REACHER_BASE_URL}
      - SEARX_BASE=${SEARX_BASE}
      - OPENSEARCH_URL=${OPENSEARCH_URL}
      - REDIS_URL=${REDIS_URL}
      - OSINT_INDEX=${OSINT_INDEX}
      - EMBED_DIM=${EMBED_DIM}
      - OPENSEARCH_HOST=opensearch
      - OPENSEARCH_PORT=9200
      - OPENSEARCH_USER=admin
      - OPENSEARCH_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-admin}
      - PYTHONPATH=/app
      # containers ŒºŒπŒªŒ¨ŒΩŒµ ŒºŒµœÑŒ±Œæœç œÑŒøœÖœÇ ŒºŒ≠œÉœâ service DNS + internal port
      - SEARXNG_BASE_URL=http://searxng:8080
      - SEARXNG_URL=http://searxng:8080
    volumes:
      - ./exports:/app/exports
      - ./:/app
    # simple healthcheck so you ŒæŒ≠œÅŒµŒπœÇ œåœÑŒπ Œ±Œ∫ŒøœçŒµŒπ œÉœÑŒø 8000
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python - <<'PY'\nimport urllib.request,sys; \ntry:\n  r=urllib.request.urlopen('http://127.0.0.1:8000/docs', timeout=3)\n  sys.exit(0 if r.status<400 else 1)\nexcept Exception:\n  sys.exit(1)\nPY"
        ]
      interval: 10s
      retries: 15
      start_period: 20s
    depends_on:
      opensearch:
        condition: service_healthy
      searxng:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - osint

  searxng:
    image: searxng/searxng:latest
    container_name: osint-searxng
    ports:
      - "8081:8080"
    restart: unless-stopped
    environment:
      # ŒíŒµŒ≤Œ±ŒπœéœÉŒøœÖ œåœÑŒπ Œ¥ŒµœÉŒºŒµœçŒµŒπ œÑŒ∑ŒΩ ŒµœÉœâœÑŒµœÅŒπŒ∫ŒÆ 8080
      - BIND_ADDRESS=0.0.0.0:8080
      # (œÄœÅŒøœÑŒµŒØŒΩŒµœÑŒ±Œπ) Œ≤Œ¨ŒªŒµ œÄœÅŒ±Œ≥ŒºŒ±œÑŒπŒ∫œå secret œÉœÑŒø .env => SEARXNG_SECRET_KEY=...
      - SEARXNG_SECRET_KEY=${SEARXNG_SECRET_KEY}
      # optional ‚Äì Œ≤ŒøŒ∑Œ∏Œ¨ œÉŒµ links/redirects
      - SEARXNG_BASE_URL=http://localhost:8081/
      # image-specific secret key setting remains for SearXNG
      - SearXNG__system__secret_key=${SEARXNG_SECRET_KEY}
    healthcheck:
      test: [ "CMD-SHELL", "python3 -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:8080').status < 400 else 1)\"" ]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - osint

  opensearch:
    image: opensearchproject/opensearch:2
    environment:
      - discovery.type=single-node
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - bootstrap.memory_lock=true
      # üî¥ ŒöŒªŒµŒπœÉœÑœå œÑŒø security ŒµŒΩœÑŒµŒªœéœÇ:
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - DISABLE_SECURITY_PLUGIN=true
      # (ŒëŒù œÄœÅŒøœÑŒπŒºŒ¨œÇ ŒºŒµ security, Œ±œÜŒ±ŒØœÅŒµœÉŒµ œÑŒπœÇ 2 œÄŒ±œÅŒ±œÄŒ¨ŒΩœâ Œ∫Œ±Œπ Œ≤Œ¨ŒªŒµ
      # OPENSEARCH_INITIAL_ADMIN_PASSWORD=MyStrongPassw0rd! )
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9200 >/dev/null || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 30
    ports:
      - "9200:9200"
    networks:
      - osint


  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2
    environment:
      - OPENSEARCH_HOSTS=["http://opensearch:9200"]
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    depends_on:
      opensearch:
        condition: service_healthy
    ports:
      - "5601:5601"
    networks:
      - osint

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - osint

  # Œ†œÅŒøŒ±ŒπœÅŒµœÑŒπŒ∫Œ¨ / Œ≤Œ±œÅŒπŒ¨ services œÉœÑŒø profile "extras"
  social-analyzer:
    image: bukshee/social-analyzer:latest
    environment:
      - PORT=9005
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    ports:
      - "9005:9005"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9005 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
    profiles: ["extras"]
    networks:
      - osint

  reacher:
    image: reacherhq/backend:latest
    environment:
      - LOG_LEVEL=info
    ports:
      - "8082:8080"
    deploy:
      resources:
        limits:
          memory: 512M
    profiles: ["extras"]
    networks:
      - osint

  theharvester:
    image: ghcr.io/laramies/theharvester:latest
    entrypoint: ["/bin/sh", "-c", "tail -f /dev/null"]
    tty: true
    stdin_open: true
    volumes:
      - ./data/harvester_results:/results
    deploy:
      resources:
        limits:
          memory: 256M
    profiles: ["extras"]
    networks:
      - osint

  phoneinfoga:
    image: sundowndev/phoneinfoga:latest
    command: "serve -p 8080"
    ports:
      - "8083:8080"
    networks:
      - osint

  # ------------------------
  # üß™ TEST SERVICE
  # ------------------------
  orchestrator-tests:
    build: ./orchestrator
    working_dir: /app
    command: >
      bash -c "
        pip install -U pytest pytest-asyncio respx &&
        pytest -q"
    environment:
      - GOOGLE_CSE_API_KEY=${GOOGLE_CSE_API_KEY}
      - GOOGLE_CSE_CX=${GOOGLE_CSE_CX}
      - REACHER_BASE_URL=${REACHER_BASE_URL}
      - SEARX_BASE=${SEARX_BASE}
      - OPENSEARCH_URL=${OPENSEARCH_URL}
      - REDIS_URL=${REDIS_URL}
      - OSINT_INDEX=${OSINT_INDEX}
      - EMBED_DIM=${EMBED_DIM}
      - PYTHONPATH=/app
      - SEARXNG_BASE_URL=http://searxng:8080
      - SEARXNG_URL=http://searxng:8080
    volumes:
      - ./exports:/app/exports
      - ./tests:/app/tests
      - ./orchestrator:/app/orchestrator
    depends_on:
      opensearch:
        condition: service_healthy
      searxng:
        condition: service_healthy
      redis:
        condition: service_started
    profiles:
      - tests
    networks:
      - osint

networks:
  osint:
